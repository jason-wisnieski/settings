#!/bin/bash

set -e

BASELOGDIR="$HOME/logs"
WINFORMAT="false"

print_usage() {
	NAME=$(basename "$0")
	echo "$NAME: Generate logfiles from git repositories"
	echo ""
	echo "Usage: $NAME [options] <directories>"
	echo ""
	echo "Options:"
	echo "  -h: Print this message"
	echo "  -w: Log files have Windows line endings"
	echo "  -d <dir>: Specify output directory (default is $BASELOGDIR)"
	echo ""
}

get_logs() {
	pushd "$1" > /dev/null

	PROJECT=$(basename "$PWD")
	LOGDIR="$BASELOGDIR/$PROJECT"

	mkdir -p "$LOGDIR"
	export LOGDIR
	git log --pretty=format:'%h (%ai)%d %an: %s' --all > "$LOGDIR/PROJECT.log"
	git submodule foreach 'git log --pretty=format:"%h (%ai)%d %an: %s" > "$LOGDIR/$(basename $name).log"'

	# Convert to Windows line endings
	if [ "$WINFORMAT" == "true" ]; then
		pushd "$LOGDIR" > /dev/null
		for file in *.log; do
			sed --in-place -e 's/$/\r/' "$file"
		done
		popd > /dev/null
	fi

	popd > /dev/null
}

while [ $# -gt 0 ]; do
	case "$1" in
		"-h")
			print_usage
			exit 0
			;;
		"-w")
			echo "Using Windows line endings"
			WINFORMAT="true"
			shift 1
			;;
		"-d")
			echo "Using $2 as log directory"
			LOGDIR=$2
			shift 2
			;;
		*)
			echo "Generating logs for ${1}..."
			get_logs "$1"
			shift 1
			;;
	esac
done
